---
import data from '../data/projects.json';
import { Image } from 'astro:assets';
import findOutWhy from '../assets/find-out-why.gif';
import iconClose from '../assets/icons/close.svg';
import iconPrev from '../assets/icons/arrow-right.svg';
import iconNext from '../assets/icons/arrow-left.svg';
---

<div class="swiper-body pl-4 opacity-0">
  <div class="swiper">
    <div class="swiper-wrapper">
      <div class="swiper-slide columns-3xl max-w-3xl">
        ... a carousel only for 4 items? Everything has an explanation. <a id="open-modal" class="font-bold cursor-pointer underline hover:no-underline" onclick="window.dialog.showModal()">Find out why</a>
      </div>
      
      {
        data.map(item => {
          const { tag, image, title, copy, href } = item;

          return (
            <div class="swiper-slide columns-3xl max-w-3xl">
              <div class="card flex flex-col">
                { tag && <div class="card-tag">{ tag }</div> }
                { image && <Image class="flex" src={import(`../assets/projects/${image}.png`)} alt={ title } /> }
                { 
                  (title || copy) ?
                  <a href={href}>
                    <div class="card-text flex flex-col gap-1">
                      { title && <div class="card-text_title">{ title }</div> }
                      { copy && <div class="card-text_copy">{ copy }</div> }
                    </div>
                  </a> : null
                }
              </div>
            </div>
          )
        })
      }
    </div>
    <!-- <div class="swiper-pagination"></div> -->
    <div class="link-animated swiper-button-prev"><img alt="Previus" src={iconPrev.src} /></div>
    <div class="link-animated swiper-button-next"><img alt="Next" src={iconNext.src} /></div>
    <!-- <div class="swiper-scrollbar"></div> -->
  </div>
</div>

<dialog id="dialog" class="modal">
  <button class="link-animated close-modal" onclick='window.dialog.close();'><img alt="Close modal" src={iconClose.src} /></button>
  <main class="columns-6xl max-w-6xl mx-auto">
    <div class="">
      <div class="gif-sticky bg-lime-500 w-fit p-4 mx-auto hidden">
        <img src={findOutWhy.src} />
        <div>gif animado</div>
      </div>
      <div class="modal-text-top font-serif font-light text-[52px] leading-[130%]">After 20 years, of course I don’t have more to display—either I didn’t save anything, it doesn’t exist anymore, it’s all under NDA, it’s stuck in a server that no one remembers the password for, the prototypes self-destruct (thank you Invision), it's stored on a floppy disk that no one remembers how to read, the files were accidentally overwritten by another project, the client lost access to the original files, I deleted it to protect humanity from its brilliance, the projects were too innovative for anyone to understand, it's stored on a floppy disk that no one remembers how to read, the files were accidentally overwritten by another project, the client lost access to the original files, I deleted it to protect humanity from its brilliance, the projects were too innovative for anyone to understand, it's stored on a floppy disk that no one remembers how to read, the files were</div>
    </div>
  </main>
</dialog>


<style>
  .swiper-body{
    /* position: relative; */
  }
  .swiper-wrapper {
    padding: 16px 0;
  }

  dialog {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    max-width: none;
  }

  dialog::backdrop {
    position: fixed;
    height: 100%;
    top: 0px;
    right: 0px;
    bottom: 0px;
    left: 0px;
    /* background: rgba(255, 255, 255, 1); */
    background-color: aqua;
  }
  dialog .close-modal {
    position: absolute;
    top: 16px;
    right: 16px;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    outline-color: var(--color-active);
  }
  dialog .modal-text-top {
    padding: 62px 32px 0px 32px;
  }
  dialog .gif-sticky {
    transition: all 1s ease;
  }


  .card {
    position: relative;
    box-shadow: 0px 0px 12px 4px rgba(67,67,103,0.2);
  }
  .card-tag {
    background-color: var(--color-highlight);
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 4px 12px;
    border-radius: 2px;
    font-size: 13px;
    font-weight: 500;
  }
  .card-text {
    background-color: white;
    padding: 16px;
  }
  .card-text_title {
    font-size: 15px;
    font-weight: 600;
  }
  .card-text_copy {
    font-size: 15px;
    font-weight: 400;
    color: #A3A3B2;
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';
  
  const body = document.body;
  const dialog = document.querySelector('dialog');

  const gifSticky = document.querySelector('.gif-sticky');
  const modalTextTop = document.querySelector('.modal-text-top');

  const openModal = document.getElementById('open-modal');
  const closeModal = document.querySelector('.close-modal');

  // Función para obtener la altura de la ventana
  function getWindowHeight() {
    return window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
  }

  // Variable global para la altura de la ventana
  let windowHeight = getWindowHeight();

  function addPositionToGif(clientHeightDialog = windowHeight) {
    // (gifSticky as HTMLElement).style.transform = `translateY(${clientHeightDialog + 200}px)`;
    // setTimeout(() => {
    //   (gifSticky as HTMLElement).classList.remove('opacity-0');
    //   (gifSticky as HTMLElement).classList.remove('invisible');
    // }, 500);
    
    // dialog?.addEventListener('scroll', () => {
    //   if(dialog.scrollTop > 100) {
    //     (gifSticky as HTMLElement).style.transform = '';
    //     (gifSticky as HTMLElement).classList.add('sticky', 'top-0');
    //   }
    // });
  }

  function checkGifStickyClasses() {
  }

  openModal?.addEventListener('click', () => {
    body.style.overflow = 'hidden';
    console.log('open modal');
    // const rect = gifSticky ? gifSticky.getBoundingClientRect() : null;

    // let clientHeightDialog = (dialog as HTMLElement).clientHeight;
    // addPositionToGif(clientHeightDialog);
    
    // if (modalTextTop && rect && typeof rect.height === 'number') {
    //   (modalTextTop as HTMLElement).style.marginTop = `-${rect.height}px`;
    // }

    onLoadDialog()
  });
  
  closeModal?.addEventListener('click', () => {
    console.log('close modal');
    body.style.overflow = 'auto';
  });


  // function gifMarginTop() {
  //   const rect = gifSticky ? gifSticky.getBoundingClientRect() : null;

  //   if (modalTextTop && rect && typeof rect.height === 'number') {
  //     (modalTextTop as HTMLElement).style.marginTop = `-${rect.height}px`;
  //   }
  // }

  function onLoadDialog() {
    console.log('onLoadDialog')
    // gifMarginTop();
  }

  function getContainerMargin() {
    const container = document.getElementById('heading');
    if (!container) return 100; // valor por defecto
    const containerStyles = window.getComputedStyle(container);
    return parseInt(containerStyles.marginLeft);
  }

  let swiper: any;

  function loadSwiper() {
    const swiperBody = document.querySelector('.swiper-body');

    // console.log('swiperBody:: ', swiperBody);

    // Destruir la instancia anterior si existe
    if (swiper) {
      swiper.destroy(true, true);
    }

    // Crear nueva instancia usando la variable global
    if (!swiperBody) return;
    swiper = new Swiper('.swiper', {
      modules: [Navigation, Pagination],
      on: {
        init: function () {
          swiperBody?.classList.remove('opacity-0');
        },
      },
      spaceBetween: 32,
      slidesOffsetBefore: getContainerMargin(),
      slidesOffsetAfter: getContainerMargin(),
      slidesPerView: 3.41,
      slidePrevClass: 'opacity-0',
      breakpoints: {
        375: {
          slidesPerView: 1.25,
          spaceBetween: 20
        },
        768: {
          slidesPerView: 2.25,
          spaceBetween: 20
        },
        1024: {
          slidesPerView: 3.41,
          spaceBetween: 32
        }
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      }
    });
  }

  function handleResize() {
    // Actualizar windowHeight cuando cambie el tamaño de la ventana
    const swiperBody = document.querySelector('.swiper-body');
    if (!swiperBody) return;

    windowHeight = getWindowHeight();
    
    // Actualizar swiper
    if (swiper) {
      swiper.params.slidesOffsetBefore = getContainerMargin();
      swiper.params.slidesOffsetAfter = getContainerMargin();
      swiper.update();
    }
  }




  window.addEventListener('load', function() {
    loadSwiper();
  });
  
  // Eventos de Astro para la carga inicial y navegación
  ['astro:page-load', 'astro:after-swap'].forEach(event => {
    document.addEventListener(event, () => {
      loadSwiper();
      // addPositionToGif(windowHeight);
      // handleResize();
    });
  });  

  // Debounce function para mejorar el rendimiento
  function debounce<T extends (...args: any[]) => any>(
    func: T,
    wait: number
  ): (...args: Parameters<T>) => void {
    let timeout: ReturnType<typeof setTimeout> | undefined;
    
    return function executedFunction(this: any, ...args: Parameters<T>): void {
      const later = () => {
        clearTimeout(timeout);
        func.apply(this, args);
      };
      
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Crear una referencia al handler con debounce
  const debouncedResize = debounce(handleResize, 150);

  // Evento resize para actualizar el offset con debounce
  window.addEventListener('resize', debouncedResize);

  // Limpiar los event listeners cuando se desmonte el componente
  document.addEventListener('astro:before-swap', () => {
    window.removeEventListener('resize', debouncedResize);
    // if (swiper) {
    //   swiper.destroy(true, true);
    // }
  });
</script>